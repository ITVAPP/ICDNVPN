name: Build Android APK
on:
  workflow_dispatch:  # 仅手动触发
    inputs:
      libv2ray_version:
        description: 'libv2ray version (e.g., v25.8.3)'
        required: false
        default: 'v25.8.3'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.0'
        channel: 'stable'
    
    # 检查并下载 libv2ray.aar（如果不存在）
    - name: Check and download libv2ray.aar
      run: |
        # 检查文件是否已存在
        if [ -f android/app/libs/libv2ray.aar ]; then
          echo "libv2ray.aar already exists"
          ls -lh android/app/libs/libv2ray.aar
        else
          echo "libv2ray.aar not found, downloading..."
          
          # 创建 libs 目录
          mkdir -p android/app/libs
          
          # 下载 libv2ray.aar
          VERSION="${{ github.event.inputs.libv2ray_version || 'v25.8.3' }}"
          echo "Downloading libv2ray.aar version $VERSION..."
          
          wget -O android/app/libs/libv2ray.aar \
            "https://github.com/2dust/AndroidLibXrayLite/releases/download/$VERSION/libv2ray.aar" || {
              echo "Download failed, trying alternative source..."
              # 备用下载源（如果有的话）
              exit 1
            }
          
          # 验证下载
          if [ ! -f android/app/libs/libv2ray.aar ]; then
            echo "Error: Failed to download libv2ray.aar"
            exit 1
          fi
          
          echo "Downloaded successfully!"
          ls -lh android/app/libs/libv2ray.aar
        fi
    
    - name: Fix gradlew permissions
      run: |
        sed -i 's/\r$//' android/gradlew
        chmod +x android/gradlew
    
    - name: Get dependencies
      run: flutter pub get
    
    - name: Build APK
      run: |
        flutter build apk --release --split-per-abi
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: apk-release
        path: build/app/outputs/flutter-apk/*.apk
