name: Build Android APK
on:
  workflow_dispatch:  # 仅手动触发
    inputs:
      build_arm64:
        description: '是否编译 ARM64-v8a 版本'
        required: false
        default: false
        type: boolean
      build_universal:
        description: '是否编译通用版本 (ARM v7a + ARM64-v8a)'
        required: false
        default: false
        type: boolean
      enable_obfuscation:
        description: '是否启用 Dart 代码混淆'
        required: false
        default: false
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.0'
        channel: 'stable'

    - name: Fix gradlew permissions
      run: |
        sed -i 's/\r$//' android/gradlew
        chmod +x android/gradlew

    - name: Get dependencies
      run: flutter pub get

    # 默认始终构建 ARM v7a 版本
    - name: Build APK - ARM v7a (always)
      run: |
        if [ "${{ github.event.inputs.enable_obfuscation }}" = "true" ]; then
          flutter build apk --release --target-platform android-arm --obfuscate --split-debug-info=debug-info/arm-v7a
        else
          flutter build apk --release --target-platform android-arm
        fi

    # 可选：构建 ARM64-v8a 版本
    - name: Build APK - ARM64-v8a (optional)
      if: ${{ github.event.inputs.build_arm64 == 'true' }}
      run: |
        if [ "${{ github.event.inputs.enable_obfuscation }}" = "true" ]; then
          flutter build apk --release --target-platform android-arm64 --obfuscate --split-debug-info=debug-info/arm64-v8a
        else
          flutter build apk --release --target-platform android-arm64
        fi

    # 可选：构建通用版本 (ARM v7a + ARM64-v8a)
    - name: Build APK - Universal (optional)
      if: ${{ github.event.inputs.build_universal == 'true' }}
      run: |
        if [ "${{ github.event.inputs.enable_obfuscation }}" = "true" ]; then
          flutter build apk --release --target-platform android-arm,android-arm64 --obfuscate --split-debug-info=debug-info/universal
        else
          flutter build apk --release --target-platform android-arm,android-arm64
        fi

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: apk-release
        path: build/app/outputs/flutter-apk/*.apk
